# managed-serviceaccount-e2e

An e2e test lib for managed-serviceaccount

## Prereq
This will be called after ACM/MCE is installed.


## Tests
The tests in this container will:
1. Enable managed-serviceaccount feature on hub
2. Install managed-serviceaccount addon on managed clusters
3. Create managed-serviceaccount
4. Validate token secret generated by the managed-serviceaccount
5. Delete managed-serviceaccount
6. Disable managed-serviceaccount addon

## Running E2E

1. clone this repo:

```
git clone git@github.com:stolostron/managed-serviceaccount-e2e.git
cd managed-serviceaccount-e2e
```

2. copy `pkg/tests/e2e/resources/options_template.yaml` to `pkg/tests/e2e/resources/options.yaml`, and update values specific to your environment:

```
cp pkg/tests/e2e/resources/options_template.yaml pkg/tests/e2e/resources/options.yaml
```

3. run testing:

From the project root:
```
make run
```

## Running with Docker

1. clone this repo:

```
git clone git@github.com:stolostron/managed-serviceaccount-e2e.git
cd managed-serviceaccount-e2e
```

2. copy `pkg/tests/e2e/resources/options_template.yaml` to `pkg/tests/e2e/resources/options.yaml`, and update values specific to your environment:

```
cp pkg/tests/e2e/resources/container_options_template.yaml pkg/tests/e2e/resources/container_options.yaml
```

3. Run `make build-image`. This will create a docker image:

```
make build-image
```

4. run the following command to get docker image ID, we will use this in the next step:

```
export DOCKER_IMAGE_ID=`docker images | grep managed-serviceaccount-e2e | sed -n '1p' | awk '{print $3}'`
```


5. Run the test

```
export HUB_KUBECONFIG=<hub-kubeconfig>
export MC_KUBECONFIG=<managedcluster-kubeconfig>
docker run --net=host -v $HUB_KUBECONFIG:/opt/.kube/config -v $MC_KUBECONFIG:/opt/.kube/import-kubeconfig -v $(pwd)/results:/results --mount type=bind,source=$(pwd)/pkg/tests/e2e/resources/container_options.yaml,target=/resources/options.yaml $DOCKER_IMAGE_ID
```

NOTE: `--net=host` is added for testing with locally hosted kind clusters

In Canary environment, this is the container that will be run - and all the volumes etc will passed on while starting the docker container using a helper script.
